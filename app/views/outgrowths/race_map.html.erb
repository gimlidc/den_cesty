<% content_for :head do %>
  <%= javascript_include_tag "//api.mapy.cz/loader.js" %>
  <script>Loader.load()</script>
<% end %>

<h1><%= @walker.name + " " + @walker.surname %> - záznam závodu "<%= @race.name_cs %>"</h1>

<div id="map"></div>
<script type="text/javascript">
    let checkpoints = [<%= raw @checkpoints.to_json %>];
    let trks = <%= raw @trks %>;

    let center = SMap.Coords.fromWGS84(
        <%=
        if !@checkpoints.empty? then
          @checkpoints.first.coordinates
        else
          "14.41790, 50.12655"
        end
        %>);
    let m = new SMap(JAK.gel("map"), center, 9);
    m.addDefaultLayer(SMap.DEF_TURIST).enable();
    m.addDefaultControls();

    let sync = new SMap.Control.Sync({bottomSpace: 30});
    m.addControl(sync);

    let layer = new SMap.Layer.Marker();
    let all_coords = [];

    for (let i = 0; i < <%= @checkpoints.size %>; i++) {
        let lon = checkpoints[0][i].longitude;
        let lat = checkpoints[0][i].latitude;
        let coords = SMap.Coords.fromWGS84(lon, lat);
        all_coords.push(coords);

        if (i == 0) {
            let marker = new SMap.Marker(coords, 0, {url: SMap.CONFIG.img + "/marker/drop-blue.png"});
            let card = new SMap.Card();
            card.getHeader().innerHTML = "Start závodu";
            marker.decorate(SMap.Marker.Feature.Card, card);
            layer.addMarker(marker);
        }
    }

    m.addLayer(layer);
    layer.enable();

    // Add polyline:
    let polyline_layer = new SMap.Layer.Geometry();
    m.addLayer(polyline_layer);
    polyline_layer.enable();

    let polyline_options = {
        color: "#00f",
        width: 3
    };

    let polyline = new SMap.Geometry(SMap.GEOMETRY_POLYLINE, null, all_coords, polyline_options);
    polyline_layer.addGeometry(polyline);

    // ADD WALKER LAYER

    let walker_polyline_layer = new SMap.Layer.Geometry();
    m.addLayer(walker_polyline_layer);
    walker_polyline_layer.enable();

    let walker_coords = trks.map(trk => SMap.Coords.fromWGS84(trk["longitude"], trk["latitude"]))

    let walker_layer_options = {
        color: "#f00",
        width: 2
    };

    let polyline2 = new SMap.Geometry(SMap.GEOMETRY_POLYLINE, null, walker_coords, walker_layer_options);
    walker_polyline_layer.addGeometry(polyline2);




</script>
